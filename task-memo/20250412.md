# タスクメモ: FunctionExpr リネームとハンドラ構文修正 (2025-04-12)

## 1. 元々の目標

-   文法定義 (`LambdaExpr`) と AST (`Expr::LambdaExpr`) を `FunctionExpr` にリネームする。
-   関数式の構文を `fn (...) => ...` 形式に変更する (`=>` を追加)。
-   ハンドラ宣言 (`handler`) 内の関数定義構文を、上記 `FunctionExpr` に合わせて `let name = fn (...) => ...` の形式に変更する。

## 2. 完了した作業

-   **文法ドキュメント (`docs/language-spec/12-grammar.md`) の更新:**
    -   `LambdaExpr` を `FunctionExpr` にリネーム。
    -   `FunctionExpr` に `=>` を追加。
    -   `HandlerMember` の定義を `LetHandlerFunction | FieldDecl` に変更。
    -   `LetHandlerFunction`, `HandlerFunctionBody`, `ResumeFunctionExpr`, `NoResumeFunctionExpr` の定義を追加。
    -   関連する説明箇所を修正。
-   **AST (`src/protorun/ast/mod.rs`) の更新:**
    -   `Expr::LambdaExpr` を `Expr::FunctionExpr` にリネーム。
    -   ハンドラ関連の新しい struct/enum (`HandlerDecl`, `HandlerMember`, `FieldDecl`, `LetHandlerFunction`, `HandlerFunctionBody`, `ResumeFunctionExpr`, `NoResumeFunctionExpr`, `GenericParam`, `ResumeType`) を追加。
    -   `Decl` enum に `HandlerDecl` バリアントを追加。
    -   `TypeDecl`, `TraitDecl`, `ImplDecl` の `type_parameters` フィールドの型を `Vec<String>` から `Vec<GenericParam>` に変更。
-   **パーサー (`src/protorun/parser/`) の更新:**
    -   `expressions.rs`: `lambda_expr` を `function_expr` にリネームし、`=>` をパースするように修正。
    -   `declarations.rs`: `parse_handler_declaration`, `parse_handler_member`, `parse_field_declaration`, `parse_let_handler_function`, `parse_handler_function_body`, `parse_resume_function_expr`, `parse_no_resume_function_expr`, `parse_resume_type`, `parse_generic_params` を追加・修正。
    -   `declarations.rs`: `parse_declaration` に `parse_handler_declaration` を追加。
    -   `modules.rs`: `parse_module` 内で `Decl::HandlerDecl` を処理するように修正。
    -   `expressions.rs`: `AssignmentExpr` AST ノードに対応する `assignment_expr` パーサーを追加し、`expression` パーサーの優先順位を調整。
-   **関連ファイルの更新:**
    -   `ast/tests.rs`: `FunctionExpr` へのリネームと `HandlerDecl` マッチアーム追加を反映。
    -   `parser/tests_*.rs`: `FunctionExpr` へのリネームと `=>` 構文を反映。ハンドラ宣言のテストを追加。
    -   `main.rs`: `expr_to_string`, `decl_to_string` に `FunctionExpr`, `HandlerDecl`, `Assignment` の処理を追加。
-   **テストとデバッグ:**
    -   `cargo check` と `cargo test` を繰り返し実行し、多数のコンパイルエラーとテスト失敗を修正。
    -   `match` 式のテスト失敗原因調査のため、`expressions.rs` と `patterns.rs` にデバッグコードを追加。

## 3. 残っている作業

-   **テスト失敗の修正:**
    -   `test_parse_match_expr` (`expressions.rs`) の失敗を修正。
    -   `test_parse_pattern_with_guard` (`patterns.rs`) の失敗を修正。
-   **デバッグコードの削除:**
    -   `expressions.rs` と `patterns.rs` から追加した `dbg!` や `println!` を削除。
-   **未実装パーサーの実装:**
    -   `declarations.rs`: `parse_handler_function_body` 内の `resume`/`noresume` の詳細な型パース（`ResumeType` など）。
    -   `declarations.rs`: `parse_generic_params` での型制約のパース。
    -   `declarations.rs`: `parse_trait_declaration`, `parse_impl_declaration` 内でのメソッド定義のパース。
-   **テストの拡充:**
    -   `resume`/`noresume` を含むハンドラ関数のテストケースを追加。
    -   代入式のテストケースを追加。
-   **警告の修正:**
    -   `cargo fix` を実行して未使用のインポート警告などを修正。
-   **最終確認とコミット/プッシュ:**
    -   すべてのテストが通ることを確認後、変更をコミットしてプッシュ。

## 4. 現在判明している問題

-   **テスト失敗:** `test_parse_match_expr` と `test_parse_pattern_with_guard` が `Syntax("構文解析エラー: Char('}')")` で失敗する。
-   **原因:** デバッグ出力によると、`match_case` パーサー内のガード節 (`if expression`) をパースする `expression_parser` (実体は `expression` 関数) が、ガード式 (`n > 0`) のパースに失敗し、入力を消費せずに `None` を返している。これにより `opt` が `None` を返し、後続のパーサーが予期しない入力に遭遇してエラーとなっている。根本原因は、`assignment_expr` 導入による `expression` パーサーの優先順位変更が、ガード節の文脈で正しく機能していないことにある可能性が高い。

## 5. 次のタスクでのアクション

1.  `src/protorun/parser/patterns.rs` の `match_case` 関数と、それが呼び出す `src/protorun/parser/expressions.rs` の `expression` および関連パーサー（特に `assignment_expr`, `comparison`）を重点的にデバッグし、ガード式 `n > 0` がなぜパースに失敗するのかを特定・修正する。
2.  テストが成功したら、追加したデバッグコードを削除する。
3.  残っている作業リスト（上記3）を順次進める。
