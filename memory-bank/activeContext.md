# アクティブコンテキスト

## 現在の焦点
- 新しいプログラミング言語「Protorun」の設計と実装
- 言語仕様の詳細化と形式化
- 実装計画の策定
- サンプルコードの充実
- 言語仕様書の構造と内容の改善

## 最近の変更
- コンテキスト型と管理型の統合：
  - コンテキスト型を削除し、管理型に暗黙的なパラメータとしての機能を追加
  - 関数シグネチャで`with db: Database`のように暗黙的なパラメータを宣言可能に
  - `with`式を使用して暗黙的なコンテキストを提供する構文を追加
  - 言語仕様の構成を整理し、ファイルの通し番号を修正
- 言語の基本コンセプトの確立
- 型システム、関数型パラダイム、メモリ安全性の統合アプローチの検討
- 代数的効果と所有権システムの統合設計
- トレイトとデータ型の継承に関する検討と決定
- nullの排除とOption/Result型の導入
- 管理型（旧リソース型）と効果スコープの導入
- 関数合成のサポート強化（パイプライン演算子、関数合成演算子）
- サンプルコードの更新と充実（calculator.pr, state_counter.pr, ownership_example.pr）
- 制御構造の検討と決定（if式とmatch式の両方を維持）
- 設計決定の文書化（docs/design-decisions/control-structures.md）
- 実装計画の詳細化（docs/implementation-plan.md）
- with式の返り値と用途に関する言語仕様の詳細化：
  - with式がブロック内の最後の式の評価結果を返すことを明確化
  - with式の返り値を使用する具体的な例と実用的なパターンの追加
  - with式の返り値の実用的な価値（効果の局所化と結果の取得、合成性の向上、効果の組み合わせと結果の合成、リソース管理の安全性）の説明
- 言語仕様の改善：
  - ライフサイクル管理効果の言語レベルサポート（effect with lifecycle構文）
  - 管理リソースパターンの型クラス（Resource<R>型クラス）
  - コンテキスト型（context type構文）
  - 効果のスコープ化（with scoped effect構文）
  - 所有権を考慮した効果（ownキーワード）
  - 文法の拡張（新しい構文要素をEBNF文法に追加）
- 言語仕様の簡素化：
  - キーワード数の削減（7個削除、2個追加、純減5個）
  - 構文の統一と命名の一貫性向上
  - 複雑な機能の簡素化と直感的な表現
- 代数的効果の実装方法の更新：
  - 効果ハンドラの定義にimpl構文に似た`handler`構文を導入
  - 暗黙的な継続と明示的な継続のハイブリッドアプローチを採用
  - 特殊な継続制御（`noresume`、`multiresume`）のサポートを追加
  - 言語仕様を複数のファイルに分割して整理
- 言語仕様書の構造改善：
  - コンテキスト型と代数的効果の分離（新しいセクション「06-context-types.md」の作成）
  - セクション番号の調整（全12セクション）
  - 各セクションに仕様の理由や意図を追加（設計原則、利点、インスピレーションの源など）
  - 標準ライブラリセクションの充実
  - 参考文献セクションの拡充
- 制御構造の改善：
  - for式とdo式の廃止
  - Pythonスタイルのコレクションリテラル内包表記の導入（`[x * 2 for x <- numbers if x % 2 == 0]`）
  - モナド連鎖のためのbind式の導入（`bind { x <- expr1; y <- expr2; ... }`）
  - 用途に応じた構文の明確な区別（コレクション操作とモナド連鎖）
  - 言語仕様書の更新（03-expressions.md）
- 言語構文の一貫性向上：
  - 効果ハンドラの定義構文を`handler HandlerName for Effect`から`handler HandlerName: Effect`に変更
  - 効果ハンドラの使用構文を`with Effect handled by Handler`から`with Handler: Effect`に変更
  - 関数の効果注釈を`fn name(): ReturnType with Effect`から`fn name(): ReturnType & Effect`に変更
  - スコープ付き効果構文を`with scoped effect Name`から`with scoped Name`に変更
  - ライフサイクル管理効果構文を`effect Name with lifecycle`から`effect Name: lifecycle`に変更
  - 型注釈パターン「エンティティ: 型」の一貫した使用による言語全体の統一性向上

## 次のステップ
- 言語仕様の継続的な改善と形式化
- コンパイラ/インタープリタの実装計画の詳細化
- 開発環境のセットアップ
- プロトタイプ実装の開始
- 型推論、効果推論、所有権推論の相互作用の詳細設計
- 標準ライブラリの設計と仕様策定の継続
- EBNF文法の完全な形式化
- 効果ハンドラの実装方法の詳細設計
- 言語仕様書の継続的な改善（例の追加、説明の充実）
- サンプルコードの更新（新しいコレクションリテラル内包表記とbind式を使用）
- 新しい構文に合わせたサンプルコードの更新
- 文法定義（EBNF）の更新

## 開発ワークフロールール
- コミット前に必ず`git status`を実行し、変更内容を確認する
- 追加・修正・削除・リネームしたファイルをすべて`git add`または`git rm`で追跡対象に含める
- 関連する変更は一つのコミットにまとめる
- コミットメッセージは英語で、変更内容を明確に記述する
- 作業完了後は必ず`git push`を実行する

## アクティブな決定事項
- 言語名：Protorun
- 主要パラダイム：関数型プログラミングとメモリ安全性の統合
- 型システム：強力な静的型付けと型推論
- 効果システム：代数的効果による副作用の制御
- 所有権モデル：Rustに似た所有権と借用の概念
- 継承システム：トレイトの単一継承のみをサポート、データ型の継承を制限
- nullの排除：値の存在/不在はOption型で表現
- 管理型：自動リソース管理のための管理型（旧リソース型）
- 管理型の暗黙的な使用：Scalaのimplicit parameterに似た暗黙的なコンテキスト渡し
- 効果スコープ：効果の局所的な使用のためのwith式
- 関数合成：パイプライン演算子と関数合成演算子の導入
- 制御構造：if式とmatch式の両方を維持（それぞれ異なる用途に最適化）
- コレクション操作：Pythonスタイルのコレクションリテラル内包表記
- モナド連鎖：bind式
- 実装アプローチ：段階的実装（インタープリタから始め、徐々にコンパイラ機能を追加）
- リソース効果：リソース管理と効果システムの統合
- 効果ハンドラの実装：トレイト実装に似た`handler`構文を使用
- 継続の扱い：暗黙的な継続をデフォルトとし、必要に応じて明示的な制御も可能なハイブリッドアプローチ
- 型注釈パターン：「エンティティ: 型」パターンを言語全体で一貫して使用
- 効果注釈：関数の効果を`&`演算子で型と合成（`ReturnType & Effect`）
