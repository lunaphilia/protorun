# アクティブコンテキスト

## 現在の焦点
- 新しいプログラミング言語「Protorun」の設計と実装
- パーサーの機能拡張と安定化
- シンボルテーブルの機能強化
- 型チェッカーの設計準備

## 最近の変更
- 言語仕様の更新（ブロック式の説明移動と明確化）:
  - ブロック式の詳細説明を `04-statements.md` から `05-expressions.md` (セクション 5.2) に移動。
  - `04-statements.md` の概要を更新し、`05-expressions.md` へリンク。
  - `IfExpr` の文法を更新し、`then`/`else` 節で単一式を直接記述可能に変更 (`11-grammar.md`)。
  - ブロック式 (`{...}`) が複数文のグループ化に必要であることを明確化 (`05-expressions.md`)。
  - `MatchExpr`, `LambdaExpr` でも単一式とブロックの両方が使用可能であることを明記 (`05-expressions.md`)。

- 言語仕様の更新（セミコロン不要化）:
  - 文末および `BindExpr` 内のセミコロンを不要とする仕様に変更。
  - 文法定義 (`11-grammar.md`) を更新。
  - 文 (`04-statements.md`) および式 (`05-expressions.md`) の説明を更新。
  - サンプルコード (`10-examples.md`) を更新。
  - 改行が文および `BindExpr` のステップの区切りとなることを明記。

- コードのクリーンアップ：
  - 未使用のインポートを削除：`cargo fix --allow-dirty`を使用して、プロジェクト全体から未使用のインポートを削除
  - 主な修正ファイル：`common.rs`（5箇所）、`modules.rs`（3箇所）、`expressions.rs`（4箇所）、`literals.rs`（2箇所）など
  - 合計29箇所の未使用インポートを削除
  - コードの可読性と保守性の向上

- パーサーのマルチパスアプローチへの変更：
  - パーサーの実装をマルチパスアプローチに変更し、コンテキスト情報の引き回しを削除
  - `simple`という接尾辞がついた関数（コンテキストを使わない純粋なパーサー関数）を標準の関数として採用し、コンテキストを使う関数を削除
  - `modules.rs`ファイルから、`parse_module_simple`などの関数を削除
  - `statements.rs`ファイルで、`let_statement_simple`などの関数の接尾辞を削除
  - `expressions.rs`ファイルで、`match_expr_simple`などの関数の接尾辞を削除
  - `declarations.rs`ファイルで、`parse_record_type_declaration_simple`などの関数の接尾辞を削除
  - デバッグ用のprint文を削除（`expressions.rs`と`modules.rs`ファイルから）
  - マルチパスアプローチでは、最初のパスでASTを構築し、その後の別のパスでコンテキスト情報（スコープなど）を処理

- モジュール構造の実装：
  - AST定義の拡張：`Module`、`ExportDecl`、`ImportDecl`、`ImportItem`などのモジュール関連の構造体・列挙型を追加
  - モジュール宣言パーサーの実装：`module Name { ... }`構文の解析
  - エクスポート宣言パーサーの実装：`export fn name() { ... }`や`export { name1, name2 }`構文の解析
  - インポート宣言パーサーの実装：`import { name1, name2 as alias } from "Module"`や`import "Module" as Alias`構文の解析
  - シンボルテーブルとの統合：モジュールスコープの開始と終了、エクスポートされた関数のシンボル登録

- 型宣言パーサーの実装：
  - AST定義の拡張：`TypeDecl`、`EnumVariant`、`TraitDecl`、`ImplDecl`などの型宣言関連の構造体・列挙型を追加
  - `Program`構造体に型宣言関連のフィールドを追加（`type_declarations`、`trait_declarations`、`impl_declarations`）
  - シンボルテーブルの拡張：`TypeInfo`構造体に型宣言の詳細情報を保持するフィールドを追加
  - 型宣言パーサーの実装：レコード型宣言、列挙型宣言、型エイリアス、トレイト宣言、実装宣言のパーサーを実装

- メンバーアクセス式（MemberAccessExpr）の実装：
  - AST拡張：`Expr` 列挙型に `MemberAccess` バリアントを追加
  - パーサー実装：`function_call` 関数を `postfix` 関数にリネームし、関数呼び出しとメンバーアクセスの両方をパースできるように拡張
  - メンバーアクセス式（`obj.property`）と関数呼び出し式（`func(args)`）を左結合性を持つ後置演算子として実装
  - チェーンされたメンバーアクセス（`obj.inner.property`）やメンバーアクセス後の関数呼び出し（`obj.method(args)`）のサポート

- シンボルテーブルの拡張と機能強化：
  - `Symbol`構造体に型情報と使用状態を追跡するフィールドを追加
  - 型定義の詳細情報を表す`TypeInfo`構造体と`TypeKind`列挙型を追加
  - シンボルの使用をマークするメソッド`mark_symbol_used`の実装
  - 未使用シンボルを検出するメソッド`find_unused_symbols`の実装
  - 特定の種類のシンボルを検索するメソッド`find_symbols_by_kind`の実装
  - スコープ内のすべてのシンボルを取得するメソッド`get_all_symbols`の実装
  - 型定義のシンボル登録ヘルパー関数`register_type_symbol`の追加

- パーサーコードのリファクタリング：
  - `src/protorun/parser/mod.rs`の`parse_expression`メソッドからデバッグ用の`println!`文を削除
  - `src/protorun/parser/expressions.rs`から未使用の`is_lambda_pattern`関数を削除
  - `src/protorun/parser/literals.rs`の`tuple`関数のインポートを修正
  - `src/protorun/parser/types.rs`の`type_parser`関数を`parse_type`に名前変更し、より一貫性のある命名規則に変更

- テストの追加：
  - 単体テストの追加（型シンボル登録、シンボル使用追跡、シンボル種類検索）
  - プロパティベーステストの追加（ランダムな入力に対するテスト）
  - proptestライブラリの導入

- タプル型の廃止：
  - 構文の曖昧さ（型のグループ化 `(T)` と単一要素タプル `(T,)` の区別）と、タプル型による可読性低下の懸念から、タプル型を言語仕様から削除
  - 文法定義 (`docs/language-spec/09-grammar.md`) から `TupleType` を削除
  - AST (`src/protorun/ast/mod.rs`) の `Type` enum から `Tuple` バリアントを削除
  - パーサー (`src/protorun/parser/types.rs`) から `tuple_type` 関数と関連コードを削除
  - テストコード (`src/protorun/parser/tests_types.rs`) からタプル型関連のテストを削除
  - 関連するヘルパー関数 (`src/main.rs` の `type_to_string`) を修正

- 言語仕様書の構成変更：
  - 文法カテゴリ（宣言、文、式）に基づいて仕様書を再構成。
  - `03-declarations.md`、`04-statements.md` を新規作成。
  - `03-expressions.md` を `05-expressions.md` にリネームし内容を整理。
  - 以降のファイルの番号を更新。
  - 関連ファイル内のリンクと目次を更新。
  - メモリバンクファイル (`activeContext.md`, `progress.md`) を更新。

- 言語仕様ドキュメントの整合性向上：
  - `docs/language-spec/` ディレクトリ内の全ドキュメントを確認し、矛盾や一貫性のない記述を修正
  - 文法定義 (`11-grammar.md`) を更新し、`export` キーワードと `enum` キーワードのルールを追加
  - 廃止されたタプル*型*に関する記述を削除 (`02-type-system.md`)
  - メンバーアクセス式 (`.`) の説明を追加 (`05-expressions.md`)
  - 可視性キーワードを `pub` から `export` に統一 (`08-modules.md`, `09-standard-library.md`)
  - `List` の定義を `enum` 構文に統一 (`09-standard-library.md`)
  - 効果ハンドラの定義・適用構文を `:` を使う形式に統一 (`09-standard-library.md`, `10-examples.md`)
  - 未定義の `try...catch` 構文を使用していた例を、`Result` 型と `noresume` ハンドラを使用する形に修正 (`07-algebraic-effects.md`, `10-examples.md`)
  - その他、不完全な記述や重複部分を整理 (`07-algebraic-effects.md`)

- 言語仕様書の構成と内容の更新:
  - `04-statements.md` を更新し、式文と `return` 文の詳細な説明を追加。
  - `03-declarations.md` を更新し、`let` 文と `var` 文の詳細な説明を追加。
  - `let`/`var` を宣言として `03-declarations.md` で扱い、式文/`return` 文を `04-statements.md` で扱う構成を採用。
  - `return` 文は廃止せず、言語機能として維持することを決定。

## 次のステップ
- 型チェッカーの設計と実装：
  - 基本的な型チェック機能の設計
  - 型推論アルゴリズムの実装
  - 型エラーの報告機能の実装
  - シンボルテーブルとの統合

- 効果推論システムの設計と実装：
  - 効果推論アルゴリズムの設計
  - 効果の型チェック機能の実装
  - 効果エラーの報告機能の実装

- 所有権チェッカーの設計と実装：
  - 所有権と借用の検証機能の設計
  - ライフタイム解析の実装
  - 所有権エラーの報告機能の実装

- 言語仕様の継続的な改善と形式化
- 効果ハンドラの実装方法の詳細設計
- サンプルコードの更新（新しい構文に合わせた更新）

## 開発ワークフロールール
- プロダクションコードを小さく修正し、こまめにテストコードを書き、テストが通ることを確認してから次のプロダクションコードの修正を行う
- テストが失敗したときには思い込みで修正する前にデバッグを行って事実から原因を特定し、的確にかつ簡潔に修正する
- 憶測で原因を断定せず、デバッグして事実を元に原因を特定し修正を行う
- テストは最上位から入力を通すのではなく、関数ごとに書いてボトムアップに関数の振る舞いが正しいことを確認する
- コミット前に必ず`git status`を実行し、変更内容を確認する
- コミットメッセージは英語で、変更内容を明確に記述する
- 作業完了後は必ず`git push`を実行する

## 文書記述のルール
- 仕様書は現在の状態と、その仕様としている意義を中心に記述する
- 他の文書で解説されている内容を重複して記述しない
- 過去の経緯や廃止された構文に関する情報は記載しない
- 文書間の参照を適切に行い、重複を避ける
- 各文書は自身の責任範囲に集中し、他の文書の内容を参照する
- 簡潔で一貫性のある記述を心がける

## アクティブな決定事項
- 言語名：Protorun
- 主要パラダイム：関数型プログラミングとメモリ安全性の統合
- 型システム：強力な静的型付けと型推論
- 効果システム：代数的効果による副作用の制御
- 所有権モデル：Rustに似た所有権と借用の概念
- 継承システム：トレイトの単一継承のみをサポート、データ型の継承を制限
- nullの排除：値の存在/不在はOption型で表現
- エラー処理：Result型ベースのエラー処理を採用、?演算子によるエラー伝搬をサポート
- 暗黙的パラメータ：関数シグネチャで`(with param: Type)`構文を使用した暗黙的なパラメータ渡し
- 効果スコープ：効果の局所的な使用のためのwith式
- 関数合成：パイプライン演算子と関数合成演算子の導入
- 制御構造：if式とmatch式の両方を維持（それぞれ異なる用途に最適化）
- コレクション操作：Pythonスタイルのコレクションリテラル内包表記
- モナド連鎖：bind式
- 実装アプローチ：段階的実装（インタープリタから始め、徐々にコンパイラ機能を追加）
- ライフサイクル管理効果：リソース管理と効果システムの統合（`LifecycleEffect<R>`型）
- 効果ハンドラの実装：`handler Name: Effect { ... }` 構文を使用
- 継続の扱い：暗黙的な継続をデフォルトとし、必要に応じて明示的な制御も可能なハイブリッドアプローチ
- 型注釈パターン：「エンティティ: 型」パターンを言語全体で一貫して使用
- 効果注釈：関数の効果を`&`演算子で型と合成（`ReturnType & Effect`）
- パーサー実装：Nomパーサーコンビネータを使用した宣言的で効率的な構文解析
- タプル型の廃止：言語からタプル*型*を削除。タプル*パターン*とタプル*値*は当面維持。
- 可視性：モジュール要素の公開には `export` キーワードを使用。
- ADT定義：代数的データ型は `enum` キーワードで定義。
- 例外処理：`try...catch` は使用せず、`noresume` ハンドラと `Result` 型で処理。
- 文末セミコロン：不要。改行が文の区切りとなる。
- 宣言と文の分類：`let`/`var` は宣言 (`03-declarations.md`)、式文/`return` は文 (`04-statements.md`) として分類。
  - `return` 文：早期リターンのための構文として維持する（代数的効果 `Exit` での完全置換は見送り）。

- 言語仕様書の構成変更（型定義とトレイト定義の移動）：
  - `02-type-system.md` から型定義とトレイト定義のセクションを削除。
  - `03-declarations.md` に型定義とトレイト定義のセクションを追加。
  - `02-type-system.md` は型システムの概念に、`03-declarations.md` は宣言構文に焦点を当てる構成に変更。

- 言語仕様書の構成変更（型定義の細分化）：
  - `03-declarations.md` の型定義セクションを、レコード型、代数的データ型（enum）、型エイリアスのサブセクションに分割。
  - 各型定義の説明を追加・整理。
