# 進捗状況

## 完了した項目
- ライフサイクル管理効果のモデル簡素化：
  - 効果ハンドラから冗長な`onClose`メソッドを削除
  - リソース管理をシンプル化：`acquire`で獲得したリソースはスコープ終了時に自動的に`release`で解放
  - 内部状態の追跡（activeConnectionsなど）を削除
  - C++のRAIIパターンやRustの所有権システムにより近いモデルに

- ライフサイクル管理効果と暗黙的パラメータの記述を05-algebraic-effects.mdに集約：
  - 02-type-system.md、04-ownership.md、03-expressions.md、08-examples.mdから関連する詳細な記述を削除
  - 05-algebraic-effects.mdの5.4節「ライフサイクル管理効果」と5.8節「暗黙的パラメータと効果システム」を拡充
  - 各ファイルに05-algebraic-effects.mdへの参照を追加
  - 重複を排除し、一貫性のある説明を提供
  - ライフサイクル管理効果の概念、目的、定義、使用方法、ハンドラ、利点などを詳細に説明
  - 暗黙的パラメータの概念、目的、宣言、提供、ライフサイクル管理効果との統合などを詳細に説明

- 暗黙的コンテキストと効果の統合：
  - 管理型を削除し、ライフサイクル管理効果（`LifecycleEffect<R>`型）に統合
  - 暗黙的パラメータの構文を`(with param: Type)`に統一
  - `lifecycle`キーワードと`with cleanup`修飾子を削除
  - リソース獲得と解放の関数名を`acquire`と`release`に固定
  - 効果ハンドラの`finalize`メソッドを`onClose`メソッドに変更
  - 言語仕様書の関連セクションを更新（05-algebraic-effects.md, 04-ownership.md, 03-expressions.md, 09-grammar.md）
- プロジェクト初期化
- メモリバンクの設定
- Protorun言語の基本コンセプト確立
- 言語パラダイムの決定（関数型+メモリ安全性）
- 主要言語機能の概要設計（型システム、効果システム、所有権モデル）
- 言語仕様書の整合性向上：
  - EBNF文法から廃止された`context type`キーワードを削除
  - 最新の構文変更をEBNF文法に反映（`managed type`→`managed`、`extends`→`:`など）
  - 関数の効果注釈を`with EffectType`から`& EffectType`に更新
  - ライフサイクル管理効果の構文を`with lifecycle`から`: lifecycle`に更新
  - スコープ付き効果式の構文を`with scoped effect`から`with scoped`に更新
  - 所有権システムの章番号を「5.」から「4.」に修正
  - 文法の説明セクションを更新して最新の設計決定を反映
  - `ForExpr`を`CollectionComprehensionExpr`と`BindExpr`に置き換え
  - EBNF文法の`TypeRef`規則に参照型（`&`と`&mut`）の構文を追加
  - 所有権システムの章に参照型の構文と意味論に関する詳細な説明を追加
- コンテキスト型と管理型の統合：
  - コンテキスト型を削除し、管理型に暗黙的なパラメータとしての機能を追加
  - 関数シグネチャで`with db: Database`のように暗黙的なパラメータを宣言可能に
  - `with`式を使用して暗黙的なコンテキストを提供する構文を追加
  - 言語仕様の構成を整理し、ファイルの通し番号を修正
- 言語仕様の更新：
  - 継承システムの最小化（トレイトの単一継承のみ）
  - nullの排除とOption/Result型の導入
  - 管理型（旧リソース型）と効果スコープの導入
  - 関数合成のサポート強化（パイプライン演算子、関数合成演算子）
  - enum構文の導入
  - 制御構造の決定（if式とmatch式の両方を維持）
  - with式の返り値と用途の詳細化（ブロック内の最後の式の評価結果を返すことの明確化、具体的な使用例と実用的な価値の説明）
  - ライフサイクル管理効果の言語レベルサポート（`LifecycleEffect<R>`型）
  - 効果のスコープ化（with scoped effect構文）
  - 所有権を考慮した効果（ownキーワード）
  - 文法の拡張と簡素化（新しい構文要素のEBNF文法への追加とキーワード削減）
  - 代数的効果の実装方法の更新：
    - 効果ハンドラの定義にimpl構文に似た`handler`構文を導入
    - 暗黙的な継続と明示的な継続のハイブリッドアプローチを採用
    - 特殊な継続制御（`noresume`、`multiresume`）のサポートを追加
  - 制御構造の改善：
    - for式とdo式の廃止
    - Pythonスタイルのコレクションリテラル内包表記の導入
    - モナド連鎖のためのbind式の導入
    - 用途に応じた構文の明確な区別（コレクション操作とモナド連鎖）
  - 言語構文の一貫性向上：
    - 効果ハンドラの定義構文を`handler HandlerName for Effect`から`handler HandlerName: Effect`に変更
    - 効果ハンドラの使用構文を`with Effect handled by Handler`から`with Handler: Effect`に変更
    - 関数の効果注釈を`fn name(): ReturnType with Effect`から`fn name(): ReturnType & Effect`に変更
    - スコープ付き効果構文を`with scoped effect Name`から`with scoped Name`に変更
    - 型注釈パターン「エンティティ: 型」の一貫した使用による言語全体の統一性向上
- 言語仕様の整理：
  - 言語仕様を複数のファイルに分割して整理
  - 各セクションの内容を明確化
  - 更新履歴の追加
- 言語仕様書の構造と内容の改善：
  - コンテキスト型と代数的効果の分離（新しいセクション「06-context-types.md」の作成）
  - セクション番号の調整（全12セクション）
  - 各セクションに仕様の理由や意図を追加（設計原則、利点、インスピレーションの源など）
  - 標準ライブラリセクションの充実
  - 参考文献セクションの拡充
  - 古いファイルの削除と整理
- サンプルコードの更新：
  - calculator.pr：enum構文、パイプライン演算子、効果スコープの使用
  - state_counter.pr：State効果にmodify操作の追加、パイプライン演算子、効果スコープの使用
  - ownership_example.pr：リソース型、パイプライン演算子、効果スコープの使用
  - 新しい効果ハンドラ構文を使用したサンプルの追加
- 設計決定文書の作成：
  - 制御構造（if式とmatch式）の比較分析と設計決定
- 実装計画の詳細化：
  - フェーズ分け（基本インタープリタ → 完全な言語機能 → 効果と所有権 → コンパイラとツール）
  - 技術選択オプションの整理（実装言語、パーサー技術、コンパイラバックエンド）
  - マイルストーンの設定と具体的なタスク分解

## 進行中の項目
- 言語仕様の継続的な改善と形式化
- 型システム、効果システム、所有権モデルの詳細設計
- 実装アプローチの詳細化
- 標準ライブラリの設計と仕様策定
- EBNF文法の完成
- 効果ハンドラの実装方法の詳細設計
- 言語仕様書の継続的な改善（例の追加、説明の充実）
- サンプルコードの更新（新しいコレクションリテラル内包表記とbind式を使用）
- 新しい構文に合わせたサンプルコードの更新

## 残りのタスク
- 言語仕様の完全な形式化（EBNF文法の完成、型システム規則）
- 型推論、効果推論、所有権推論アルゴリズムの設計
- コンパイラ/インタープリタのアーキテクチャ詳細設計
- 開発環境のセットアップ
- プロトタイプ実装の開始
- テスト戦略の策定
- 実装言語の最終決定（Rust、OCaml/F#、Haskellの比較検討）
- 効果ハンドラの実装方法のプロトタイピング
- 言語仕様書の残りのセクションの充実（特に標準ライブラリと例）

## 次の優先事項
- 実装言語の選定
- プロトタイプ開発のための環境セットアップ
- パーサーの初期実装
- リソース効果とリソース型の統合パターンの実装計画
- 管理型の暗黙的な使用の実装方式の決定
- 効果ハンドラの実装方法の検証
- 言語仕様書の継続的な改善と拡充
- 新しいコレクションリテラル内包表記とbind式のEBNF文法の詳細化

## 既知の問題
- 代数的効果と所有権システムの統合における理論的課題
- 型推論、効果推論、所有権推論の相互作用
- 関数合成と効果システムの統合における型安全性の保証
- 効果のスコープ化と所有権システムの整合性
- 簡素化された文法の実装とツールのサポート

## 解決した問題
- ライフサイクル管理効果の冗長性：
  - 効果ハンドラから冗長な`onClose`メソッドを削除
  - リソース管理をシンプル化：`acquire`で獲得したリソースはスコープ終了時に自動的に`release`で解放
  - 内部状態の追跡（activeConnectionsなど）を削除
  - C++のRAIIパターンやRustの所有権システムにより近いモデルに変更

- 暗黙的コンテキストと効果の重複：
  - 管理型を削除し、ライフサイクル管理効果（`LifecycleEffect<R>`型）に統合することで解決
  - リソース獲得と解放の関数名を`acquire`と`release`に固定することで標準化
  - 暗黙的パラメータの構文を`(with param: Type)`に統一することで明確化
  - ライフサイクル管理効果と暗黙的パラメータの記述を05-algebraic-effects.mdに集約することで重複を排除
- 言語仕様書の整合性の問題：
  - EBNF文法と本文説明の間の矛盾（廃止されたコンテキスト型の記述が残っていた問題）
  - 章番号の食い違い（所有権システムと代数的効果の章番号が重複していた問題）
  - 最新の構文変更がEBNF文法に反映されていなかった問題
- 言語機能の複雑さとシンプルさのバランス（キーワード削減と文法統一により改善）
- リソース効果とコンテキストリソースの複雑な命名（新しい命名規則により一貫性向上）
- 特殊なリソース操作の複雑さ（標準化されたopen/cleanup構文とライフサイクル管理効果により簡素化）
- 効果ハンドラの定義方法の一貫性（トレイト実装に似た`handler`構文の導入により改善）
- 継続の扱いの柔軟性（暗黙的な継続と明示的な継続のハイブリッドアプローチにより改善）
- 特殊な継続制御の表現（`noresume`、`multiresume`キーワードの導入により明確化）
- for式とdo式の用途の重複（Pythonスタイルの内包表記とbind式の導入により明確に区別）
- 言語構文の一貫性（型注釈パターン「エンティティ: 型」の導入により改善）
- 効果注釈の表現（`&`演算子による型と効果の合成により改善）
- 効果ハンドラの使用構文の冗長性（`with Handler: Effect`構文の導入により簡素化）
