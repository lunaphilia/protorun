# 進捗状況

## 完了した作業

### 言語設計
- 言語の基本コンセプトの確立
- 型システムの設計
- 代数的効果システムの設計
- 所有権システムの設計
- 効果と所有権の統合モデルの設計
- トレイトシステムの設計
- エラー処理の設計（Result型ベース）
- 制御構造の設計（if式、match式、コレクション内包表記、bind式）
- 関数合成機能の設計（パイプライン演算子、関数合成演算子）
- ライフサイクル管理効果の設計
- 暗黙的パラメータの設計と効果システムとの統合

### 言語仕様
- 言語仕様の基本構造の確立
- 型システムの仕様策定
- 式と文の仕様策定
- 所有権システムの仕様策定
- 代数的効果の仕様策定
- モジュールシステムの仕様策定
- 標準ライブラリの仕様策定（基本部分）
- 例の作成
- 文法（EBNF）の策定
- 将来の拡張に関する考察
- 参考文献の整理
- 言語仕様書の構造改善と内容の充実
- 文法（EBNF）の改善と完全化
- 文書記述のルールの確立と適用

### サンプルコード
- 電卓アプリケーション（calculator.pr）
- 状態カウンター（state_counter.pr）
- 所有権の例（ownership_example.pr）
- 基本的な挨拶プログラム（hello.pr）

### 実装
- AST（抽象構文木）モジュールの実装
- エラー処理システムの実装
- パーサーの実装（Nomパーサーコンビネータを使用）
- 複合型の構文解析器の実装：
  - 配列型（`[Int]`）
  - タプル型（`(Int, String)`）
  - ジェネリック型（`Option<Int>`）
  - 関数型（`(Int, Int) -> Int`）
  - 効果付き型（`(String) -> String & IO`）
  - 参照型（`&Int`, `&mut Int`）
  - 所有権型（`own Resource`）
  - 複雑な複合型（`Option<(Int, &mut String)>`）
- テストスイートの構築

### 実装計画
- 実装アプローチの決定（インタープリタから始め、徐々にコンパイラ機能を追加）
- 実装計画の策定

## 進行中の作業
- 言語仕様の詳細化と形式化
- 標準ライブラリの設計と仕様策定
- サンプルコードの充実
- 実装計画の詳細化
- インタープリタの機能拡張

## 今後の作業
- コンパイラ/インタープリタの実装
- 開発環境のセットアップ
- 型推論、効果推論、所有権推論の相互作用の詳細設計
- 効果ハンドラの実装方法の詳細設計
- 言語仕様書の継続的な改善
- サンプルコードの更新と充実
- 標準ライブラリの実装
- テストスイートの拡充
- ドキュメントの充実
- 言語ツールの開発（LSP、デバッガなど）

## 現在の課題
- 型推論、効果推論、所有権推論の相互作用の複雑さ
- 代数的効果と所有権システムの統合における理論的課題
- 言語機能の複雑さとシンプルさのバランス
- 実装の複雑さと実行効率のトレードオフ

## 最近の成果
- パーサーモジュールのリファクタリング：
  - パーサーを機能別に6つのモジュールに分割（common, literals, patterns, types, statements, expressions）
  - 各モジュールの責任範囲を明確化
  - Span情報の計算を改善し、エラーメッセージをより詳細に
  - 循環参照の問題を解決（patterns.rsとexpressions.rsの相互依存を解消）
  - 共通パターンをヘルパー関数として抽出
  - コードの可読性、保守性、拡張性を向上
- 制御構造の構文解析器の実装と検証：
  - if式（条件分岐）の構文解析
  - match式（パターンマッチング）の構文解析
  - コレクション内包表記の構文解析（リスト、マップ、セット）
  - bind式（モナド的バインディング）の構文解析
  - with式（代数的効果のハンドラ）の構文解析
  - テストコードのクリーンアップとデバッグ出力の削除
  - 未使用変数の警告修正

- 複合型の構文解析器の実装と検証：
  - 配列型（`[Int]`）の構文解析
  - タプル型（`(Int, String)`）の構文解析
  - ジェネリック型（`Option<Int>`）の構文解析
  - 関数型（`(Int, Int) -> Int`）の構文解析
  - 効果付き型（`(String) -> String & IO`）の構文解析
  - 参照型（`&Int`, `&mut Int`）の構文解析
  - 所有権型（`own Resource`）の構文解析
  - 複雑な複合型（`Option<(Int, &mut String)>`）の構文解析
  - テストケースの追加と検証

- インタープリタの初期実装：
  - AST（抽象構文木）モジュールの実装
  - エラー処理システムの実装
  - パーサーの実装（Nomパーサーコンビネータを使用）
  - テストスイートの構築
  - サンプルコード（hello.pr）の作成

- パーサーの改善：
  - レキサーモジュールを削除し、Nomパーサーコンビネータに完全に移行
  - 使用されていない関数を削除
  - エラーメッセージの改善（コンテキスト情報を追加）
  - 比較演算子のパース順序を最適化（2文字演算子を先に試す）
  - コードの整理と簡素化
  - 問題のあるテストを削除（test_parse_error_unexpected_eof）

- 文法（EBNF）の改善と完全化：
  - 言語仕様で解説されている構文要素を完全にカバーする文法を作成
  - 暗黙的パラメータ、ライフサイクル管理効果、コレクション内包表記、効果ハンドラなどの構文を明確に定義
  - 文書の簡潔化と文書間の参照の適切な実装

- 文書記述のルールの確立：
  - 仕様書は現在の状態と、その仕様としている意義を中心に記述
  - 他の文書で解説されている内容を重複して記述しない
  - 過去の経緯や廃止された構文に関する情報は記載しない
  - 文書間の参照を適切に行い、重複を避ける
  - 各文書は自身の責任範囲に集中し、他の文書の内容を参照する
  - 簡潔で一貫性のある記述を心がける

- エラー処理の一本化：
  - 例外処理（try/catch/throw）とResult型によるエラー伝搬の二重化を解消
  - Result型ベースのエラー処理に統一
  - サンプルコードをResult型ベースのエラー処理に更新

- ライフサイクル管理効果のモデル簡素化：
  - リソース管理をシンプル化：`acquire`で獲得したリソースはスコープ終了時に自動的に`release`で解放
  - C++のRAIIパターンやRustの所有権システムにより近いモデルに

- 言語構文の一貫性向上：
  - 効果ハンドラの定義構文と使用構文の改善
  - 関数の効果注釈の改善
  - スコープ付き効果構文の改善
  - 型注釈パターン「エンティティ: 型」の一貫した使用

## 次のマイルストーン
1. **言語仕様の完成**（目標：2025年4月末）
   - 言語仕様書の完成
   - 文法の完全な形式化
   - 標準ライブラリの仕様完成

2. **プロトタイプインタープリタの実装**（目標：2025年6月末）
   - 基本的な構文解析（完了）
   - 型チェック
   - 効果推論
   - 所有権チェック
   - 簡単なプログラムの実行

3. **コンパイラの基本機能実装**（目標：2025年9月末）
   - 中間表現（IR）の設計と実装
   - 最適化パスの実装
   - バックエンドの選定と実装

4. **言語ツールの開発**（目標：2025年12月末）
   - LSP（Language Server Protocol）の実装
   - デバッガの実装
   - パッケージマネージャの実装
