# タスク定義: 仕様書の矛盾点修正 (2025-04-17)

## 1. タスクの目的

`taskdef/20250415-effect.md` で実施された代数的効果に関する構文変更（`handler`, `with` など）に伴い、仕様書 (`docs/language-spec/`) 内に残存している古い記述や矛盾点を修正し、ドキュメント全体の整合性を確保する。

## 2. 完了条件

*   以下の対象ファイルから、特定された矛盾点が修正されていること。
*   修正後の仕様書が、最新の構文（`handler Effect for Type`, `with alias = instance [: Type]`, Effect パラメータ `(effect alias: Effect)`) と整合性が取れていること。
*   (推奨) 修正完了後に `cargo test` を実行し、ドキュメントテスト等に影響がないことを確認すること。

## 3. 具体的な計画の手順

以下のファイルを順に修正する。

*   **Step 1: `docs/language-spec/02-lexical-structure.md` の修正**
    *   2.2節のキーワードリストから、削除された `noresume` と `multiresume` の行を削除する。
*   **Step 2: `docs/language-spec/03-type-system.md` の修正**
    *   3.4節の `handler` の説明を「特定の型に対して効果インターフェースの操作を実装する」という現在の仕様に合わせて修正する。
*   **Step 3: `docs/language-spec/04-declarations.md` の修正**
    *   4.1節の `handler` の説明を、Step 2 と同様に修正する。
*   **Step 4: `docs/language-spec/10-standard-library.md` の修正**
    *   10.3節 (I/O) と 10.4節 (Async) のコード例において、以下の点を修正する。
        *   ハンドラ定義を古い `handler Name: Effect { ... }` から新しい `handler Effect for Type { ... }` 形式に変更する（必要に応じてダミーの `type` 定義を追加）。
        *   関数シグネチャの効果宣言を古い `fn ... : Type & Effect` から新しい Effect パラメータ `fn ...(effect alias: Effect) ...` 形式に変更する。
        *   ハンドラメソッド定義（`fn` ではなく `let name = fn ...`) に `self` パラメータを追加する。
*   **Step 5: (推奨) テスト実行と確認**
    *   `cargo test` を実行し、エラーや新たな警告が発生しないことを確認する。

## 4. タスクを進めるうえでの懸念事項

*   上記以外の仕様書ファイルにも、見逃している矛盾点が存在する可能性がある。修正作業中にもし見つかった場合は、適宜修正対象に含める。
*   `10-standard-library.md` のコード例修正において、代数的効果以外の構文要素（例：標準ライブラリの関数呼び出し方など）が現行の言語仕様や実装と乖離している可能性がある。発見した場合は別途報告または修正を検討する。

## 5. 完了した作業と新たな懸念事項 (2025-04-17 追記)

### 5.1 完了した作業

*   **Step 1: `docs/language-spec/02-lexical-structure.md` の修正**: 2.2節のキーワードリストから、`taskdef/20250415-effect.md`で削除されたキーワード `noresume`, `multiresume` を削除しました。
*   **Step 2: `docs/language-spec/03-type-system.md` の修正**: 3.4節「代数的効果と型システム」における `handler` の説明を、現在の仕様「特定の型に対して効果インターフェースの操作を実装する型」に合わせて修正しました。
*   **Step 3: `docs/language-spec/04-declarations.md` の修正**: 4.1節「宣言の概要」における `handler` の説明を、Step 2と同様に現在の仕様に合わせて修正しました。
*   **Step 4: `docs/language-spec/10-standard-library.md` の修正**: 10.3節(I/O)と10.4節(Async)のコード例について、以下の点を新しい構文に合わせて修正しました。
    *   ハンドラ定義を `handler IO for IOHandler { ... }` および `handler Async for AsyncHandler { ... }` の形式に変更しました。
    *   関数シグネチャの効果宣言を、従来の `& IO` や `& Async & IO` 形式から、Effectパラメータ `(effect io: IO)` や `(effect async: Async, effect io: IO)` 形式に変更しました。
    *   ハンドラメソッド定義を `let readFile = fn (self, ...)` の形式に変更し、`self` パラメータを追加しました。
    *   上記以外のコード例や説明（コアデータ構造、コレクション操作など）は、今回のタスク範囲外として変更せず、必要最小限の修正に留めました。
*   **Step 5: テスト実行と確認**: `cargo test` を実行し、ユニットテストおよびドキュメントテストがすべて成功することを確認しました。これにより、今回の修正が既存のコードやドキュメントテストに影響を与えていないことを確認しました。

### 5.2 新たな懸念事項・課題

*   **`10-standard-library.md` の他の要素の乖離**: Step 4の修正中に確認した通り、`10-standard-library.md` のコード例（特に10.2 コアデータ構造、10.5 コレクション操作、10.6 数値計算、10.7 文字列操作）には、代数的効果以外の構文要素（例: Listモジュールの関数定義、Map/Setトレイトのメソッド定義、Result型のメソッド実装、`Num` や `Eq` トレイトの使用例、`panic` 関数の呼び出しなど）で、現行の言語仕様やパーサー実装と乖離している可能性のある箇所が多く見られます。これらは標準ライブラリの具体的な仕様策定や実装と合わせて、別途タスクとして詳細な確認と修正が必要です。
*   **ドキュメント全体の網羅性と鮮度**: 今回修正した4ファイル以外にも、古い構文や概念に基づいた記述が残っている可能性があります（例: `docs/language-spec/11-examples.md` の他の例など）。言語仕様の変更に合わせて、仕様書全体を継続的にレビューし、最新の状態に保つプロセスが必要です。

## 6. その他 (名称変更)

*   **修正の背景**: このタスクは `taskdef/20250415-effect.md` で行われた構文変更を仕様書全体に反映させるためのフォローアップ作業である。
*   **対象ファイル**:
    *   `docs/language-spec/02-lexical-structure.md`
    *   `docs/language-spec/03-type-system.md`
    *   `docs/language-spec/04-declarations.md`
    *   `docs/language-spec/10-standard-library.md`
