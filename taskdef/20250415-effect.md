# タスク定義: 代数的効果の構文と仕様の改善 (2025-04-15)

## 1. 修正の目的

*   代数的効果に関する構文 (`handler`, `with`) を整理し、言語仕様の明確性と一貫性を向上させる。
*   `handler` 構文を Rust の `impl Trait for Type` に近づけ、状態定義 (`type`) と効果実装 (`handler`) を分離する。
*   `with` 式の構文を改善し、複数のハンドラ束縛をより自然かつ型安全に記述できるようにする（型注釈は推論に任せる）。
*   不要なキーワード (`noresume`, `multiresume`) を削除し、ハンドラの継続制御の振る舞いを型システムと実装ロジックで表現するように仕様を整理する。
*   上記の仕様変更に合わせて、関連する仕様書、AST定義、パーサー実装、およびテストコードを一貫して更新する。

## 2. 具体的な修正計画と順番

以下の順序で修正作業を進める。

**Step 1: 仕様書修正 (docs/)**

*   `docs/language-spec/08-algebraic-effects.md`:
    *   8.3節: `handler` 構文を `handler EffectName for HandlerName { ... }` に変更。状態は別 `type` で定義し、ハンドラは操作実装のみを含むように説明修正。`self` アクセスについて記述。
    *   8.5節: `with` 構文を `with alias1 = instance1, alias2 = instance2, ... { body }` に変更。型注釈不要（省略可能）を明記。型推論について説明。
    *   8.6節: 8.6.3節の `noresume`, `multiresume` キーワード削除。ハンドラ戻り値型 `S` と `with` 式全体の型 `S` の関係、`resume` 戻り値型 `R` について説明更新。継続0回の場合は `Nothing` 型推奨、複数回機能は削除と記述。
    *   関連コード例をすべて更新。
*   `docs/language-spec/12-grammar.md`:
    *   `HandlerDecl` EBNF を `handler TypeRef for TypeRef GenericParams? "{" HandlerMember* "}"` に変更。
    *   `HandlerMember` EBNF から `FieldDecl` を削除。
    *   `LetHandlerFunction` EBNF の本体を `FunctionExpr` に変更。
    *   `HandlerFunctionBody`, `ResumeFunctionExpr`, `NoResumeFunctionExpr` 定義を削除。
    *   `WithExpr` EBNF を `with WithBinding ("," WithBinding)* BlockExpr` に変更。
    *   `WithBinding` EBNF を `Identifier "=" Expression` として新規追加。
*   `docs/language-spec/04-declarations.md`: 4.5節の `handler` 定義の説明を修正。
*   `docs/language-spec/06-expressions.md`: 6.3節の `with` 式の説明を修正。
*   `docs/language-spec/11-examples.md`: 代数的効果を使用するサンプルコードを新しい構文に合わせて修正。

**Step 2: AST実装修正 (src/protorun/ast/mod.rs)**

*   `HandlerDecl` 構造体を修正 (`effect_type`, `target_type`, `generic_params`, `members`)。
*   `HandlerMember` enum から `Field` バリアントを削除。
*   `LetHandlerFunction` 構造体の `body` フィールドの型を `Expr` に変更。
*   `HandlerFunctionBody`, `ResumeFunctionExpr`, `NoResumeFunctionExpr` を削除。
*   `WithExpr` 構造体を修正 (`bindings: Vec<WithBinding>`, `body`)。
*   `WithBinding` 構造体を新規追加 (`alias`, `handler_instance`)。

**Step 3: パーサー実装修正 (src/protorun/parser/)**

*   `src/protorun/parser/declarations.rs`:
    *   `parse_handler_declaration` を修正 (新構文 `handler Effect for Type ...`)。
    *   `parse_handler_member` を修正 (`LetHandlerFunction` のみ)。
    *   `parse_let_handler_function` を修正 (本体は `function_expr`)。
    *   不要なパーサー関数 (`parse_field_declaration`, `parse_handler_function_body`, etc.) を削除。
*   `src/protorun/parser/expressions.rs`:
    *   `with_expr` を修正 (新構文 `with alias = instance, ...`)。
    *   `parse_with_binding` を新規追加 (`alias = instanceExpr`)。

**Step 4: パーサーテスト修正・追加 (src/protorun/parser/tests_*.rs)**

*   `tests_declarations.rs`: 既存の `handler` 関連テストを修正し、新しい構文のテストを追加。
*   `tests_expressions.rs`: 既存の `with` 式関連テストを修正し、新しい構文（複数束縛、型注釈なし）のテストを追加。

**Step 5: テスト実行と確認**

*   `cargo test` を実行し、すべてのテスト（特にパーサー関連）が成功することを確認。

## 3. 修正の完了条件

*   上記の Step 1 から Step 4 までのすべてのファイル修正が完了していること。
*   Step 5 の `cargo test` がエラーなく成功すること。
*   修正された仕様書と実装（AST、パーサー）の間で構文上の一貫性が保たれていること。

## 4. 修正にあたっての懸念事項

*   パーサーの修正、特に `with` 式の複数束縛の導入は、既存のパーサー構造との整合性に注意が必要。
*   ASTの変更は、将来実装される型チェッカーやインタープリタ/コンパイラに影響を与える可能性がある（ただし、それらの修正はこのタスクの範囲外）。
*   追加・修正するテストケースが、新しい構文のエッジケース（例: `with` 式の束縛が1つの場合、ジェネリクスを持つハンドラなど）を十分にカバーしているか確認が必要。

## 5. 完了した作業と新たな懸念事項 (2025-04-16 追記)

### 5.1 完了した作業

*   **Step 1: 仕様書修正**: 計画に基づき、以下の仕様書ファイルを修正しました。
    *   `docs/language-spec/08-algebraic-effects.md`: `handler`, `with` 構文、継続制御の説明を更新。
    *   `docs/language-spec/12-grammar.md`: 関連する EBNF 定義を更新。
    *   `docs/language-spec/04-declarations.md`: `handler` 定義の説明を更新。
    *   `docs/language-spec/06-expressions.md`: `with` 式の説明を更新。
    *   `docs/language-spec/11-examples.md`: サンプルコードを新しい構文に合わせて更新。
*   **Step 2: AST実装修正**: 計画に基づき、`src/protorun/ast/mod.rs` を修正しました。
    *   `HandlerDecl`, `WithExpr`, `LetHandlerFunction` 構造体を更新。
    *   `WithBinding` 構造体を追加。
    *   不要な enum や struct (`HandlerMember`, `FieldDecl`, `HandlerFunctionBody`, `ResumeFunctionExpr`, `NoResumeFunctionExpr`) を削除。
*   **Step 3: パーサー実装修正**: 計画に基づき、以下のパーサーファイルを修正しました。
    *   `src/protorun/parser/declarations.rs`: `parse_handler_declaration`, `parse_let_handler_function` を修正し、不要な関数を削除。
    *   `src/protorun/parser/expressions.rs`: `with_expr` を修正し、`parse_with_binding` を追加。
    *   `src/protorun/parser/modules.rs`: `parse_module` 内の `HandlerDecl` のエクスポート処理を修正。
    *   `src/main.rs`: AST 変更に合わせて AST 表示関数 (`decl_to_string`, `expr_to_string`) を修正。
*   **Step 4: パーサーテスト修正**: 計画に基づき、以下のテストファイルを修正しました。
    *   `src/protorun/parser/tests_declarations.rs`: `handler` 関連テストを修正し、不要なテストを削除。
    *   `src/protorun/parser/tests_expressions.rs`: `with` 式関連テストを修正。
*   **Step 5: テスト実行と確認**: `cargo test` を実行し、すべてのテストが成功することを確認しました。

### 5.2 新たな懸念事項・課題

*   **式としてのレコードリテラル**: `with` 式のテスト修正中に、`TypeName { field: value }` という形式のレコードリテラルが、現在のパーサーでは式として直接解釈できないことが判明しました。現状、`with alias = instance` の `instance` には識別子などを指定する必要があります。将来的に、式が期待される場所でレコードリテラルを直接記述できるようにパーサーを拡張する必要があります。関連するテストケース (`test_parse_with_expr` 内の複数束縛ケース) は一時的にコメントアウトしました。
*   **Effect パラメータの暗黙的解決**: サンプルコード (`docs/language-spec/11-examples.md`) の修正において、`with` スコープ内で呼び出される関数に Effect パラメータを明示的に渡す必要があるか、あるいは暗黙的に解決されるべきか、仕様と実装の検討が必要です。現状のサンプルコードでは「暗黙的に解決されると仮定」としていますが、これは今後の型チェックや意味解析の実装で明確にする必要があります。
*   **ハンドラのエクスポート**: `modules.rs` の修正で、`export handler ...` 構文は特定の名前をエクスポートするわけではないため、`ExportDecl::Single` として扱わないようにしました。しかし、モジュールシステムにおいてハンドラ実装をどのようにエクスポートし、他のモジュールから利用可能にするかの詳細な仕様（例: `impl Trait for Type` のように、実装自体がスコープにあれば利用可能になるのか、特定の構文が必要かなど）は未定義です。
