# 3. 型システム

## 3.1 型システムの概要と目的

Protorun言語の型システムは、静的型付け、強力な型推論、レコード型およびヴァリアント型（代数的データ型）、トレイト（型クラス）、および所有権を組み合わせた包括的なシステムです。この型システムは以下の目的で設計されています：

1. **安全性**: コンパイル時に型エラーを検出し、実行時エラーを防止します
2. **表現力**: 複雑な概念を型安全に表現するための豊富な機能を提供します
3. **抽象化**: コードの再利用と拡張を促進する抽象化メカニズムを提供します
4. **効率性**: 型消去と特殊化により、効率的なコード生成を可能にします
5. **推論可能性**: 明示的な型注釈を最小限に抑えつつ、型安全性を確保します

Protorun言語の型システムは、Hindley-Milner型推論をベースに、効果型、所有権型、トレイト制約を統合した拡張システムです。これにより、表現力と安全性のバランスを取りながら、使いやすさを実現しています。

## 3.2 基本型

```
Int, Float, Double, Bool, Char, String, Unit
```

Protorun言語の基本型は、以下の原則に基づいて設計されています：

1. **完全性**: プログラミングに必要な基本的なデータ型をすべて提供します
2. **一貫性**: 各型は明確な意味と操作を持ち、予測可能な動作をします
3. **安全性**: すべての型はnon-nullableであり、nullによる実行時エラーを防止します

特に、nullの排除は重要な設計決定です。これは、Tony Hoareが「10億ドルの間違い」と呼んだnullポインタ例外を防ぐためです。値の存在/不在はOption型で明示的に表現され、型システムによって安全に処理されます。これにより、実行時のnullチェックの必要性が減少し、コードの信頼性が向上します。

## 3.3 複合型

```
// 配列型
 [T]
 
 // 関数型
 (T1, T2, ..., Tn) -> R
 // (Effect パラメータを持つ関数の型表現は要検討)

// オプション型（値の存在/不在を表現）
Option<T>

// 結果型（成功/失敗を表現）
Result<T, E>
```

Protorun言語の複合型は、以下の原則に基づいて設計されています：

1. **合成性**: 基本型から複雑な型を構築するための明確なメカニズムを提供します
2. **型安全性**: 複合型の操作は型チェックされ、型の整合性が保証されます
3. **表現力**: 様々なデータ構造と計算パターンを表現するための豊富な型を提供します

特に注目すべき点：

- **関数型と効果**: 関数がどのような計算効果（副作用や特殊な制御フロー）を持つ可能性があるかは、関数定義時の **Effect パラメータ** (`effect alias: EffectType`) によって宣言されます（詳細は [8.4 Effect パラメータによる効果の宣言](08-algebraic-effects.md#84-effect-パラメータによる効果の宣言) を参照）。関数 *型* 自体が効果を直接表現するかどうか、あるいは Effect パラメータへの依存性を示す特別な型構文が必要かどうかは、さらなる検討が必要です。現在のところ、関数型は主に入出力の型を示します。

- **Option型とResult型**: これらはヴァリアント型（代数的データ型）として定義され ([4. 宣言](04-declarations.md#432-ヴァリアント型定義-type) を参照)、nullの代わりにOption型を使用し、例外の代わりにResult型を使用することで、エラー処理を型安全かつ明示的に行うことができます。これにより、エラーハンドリングの漏れを防ぎ、コードの堅牢性が向上します。代数的効果（特に `noresume` を使うハンドラ）も、Result 型と同様のエラー処理パターンを実現するために利用できます。

- **部分適用と関数型**: 関数の一部の引数を適用する部分適用式 ([6.8 部分適用式](06-expressions.md#68-部分適用式) を参照) は、新しい関数値を生成します。この新しい関数の型は、元の関数の型シグネチャから、適用された引数を除いた残りの引数に対応する関数型になります。例えば、`(Int, String) -> Bool` 型の関数 `f` があり、`let g = f(10, _)` のように部分適用された場合、変数 `g` に束縛される値は `String -> Bool` 型の関数になります。型推論システムは、部分適用式の結果として得られる関数の型を決定します。

## 3.4 代数的効果と型システム

代数的効果は Protorun の型システムと密接に統合されています。

- **効果インターフェース (`effect`)**: 新しい種類のインターフェースを定義します。
- **ハンドラ型 (`handler`)**: 特定の型に対して効果インターフェースの操作を実装する型を定義します。これにより、状態を持つことができ、効果の具体的な振る舞いを提供します。
- **Effect パラメータ**: 関数が特定の効果実装（ハンドラ）に依存することを型レベルで宣言します。

詳細は [8. 代数的効果](08-algebraic-effects.md) の章を参照してください。特に、ライフサイクル管理や依存性注入といったパターンが、代数的効果とハンドラ型を用いてどのように実現されるかについて説明されています。
