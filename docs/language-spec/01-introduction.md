# 1. 序論

## 1.1 言語の概要と目的

Protorun（プロトラン）は、関数型プログラミング、強力な型システム、メモリ安全性を統合した新しいプログラミング言語です。Scala、Haskell、Rustなどの言語から優れた特性を取り入れつつ、より統合的なアプローチを目指しています。

Protorun言語は、以下の課題を解決するために設計されました：

1. **安全性と表現力のトレードオフ**: 既存の言語では、安全性と表現力の間でトレードオフが発生することが多いです。Protorunは、強力な型システムと代数的効果を組み合わせることで、安全性を損なうことなく高い表現力を実現します。

2. **メモリ管理の複雑さ**: 手動メモリ管理は難しく、ガベージコレクションは予測不可能性をもたらします。Protorunは、所有権システムを採用することで、メモリ安全性を静的に保証しつつ、予測可能なリソース管理を実現します。

3. **副作用の制御**: 副作用の追跡と制御が型システムレベルで十分に統合されていない言語が多いです。Protorunは、代数的効果システムを導入することで、副作用を型レベルで追跡し、安全に制御します。

4. **学習曲線の急峻さ**: 高度な機能を持つ言語は学習障壁が高いことが多いです。Protorunは、一貫した設計原則と明確な概念モデルにより、段階的に学習できる言語を目指しています。

## 1.2 設計理念

Protorunは以下の設計理念に基づいています：

- **安全性**: 強力な型システムと所有権モデルによるメモリ安全性
  - コンパイル時に多くのバグを検出し、実行時エラーを最小限に抑えます
  - nullポインタ例外、メモリリーク、データ競合などの一般的な問題を防止します

- **表現力**: 関数型プログラミングパラダイムと代数的データ型
  - 高階関数、パターンマッチング、代数的データ型により、複雑な概念を簡潔に表現できます
  - 宣言的なプログラミングスタイルを促進し、コードの意図を明確に伝えます

- **制御性**: 代数的効果による副作用の型安全な制御
  - 副作用を型レベルで追跡し、関数の純粋性を保証します
  - 効果ハンドラにより、副作用の実装と使用を分離し、テスト容易性と再利用性を向上させます

- **シンプルさ**: 学習しやすく、読みやすい構文と強力な型推論
  - 一貫した構文と明確な概念モデルにより、言語の学習を容易にします
  - 型推論により、明示的な型注釈を最小限に抑えつつ、型安全性を確保します

- **効率性**: 高性能な実行と予測可能なリソース使用
  - 所有権システムにより、ガベージコレクションに依存せずにメモリを管理します
  - 最適化されたコンパイラにより、高性能なコードを生成します

## 1.3 コア機能の優先順位

Protorunの設計では、以下の機能を優先しています：

1. **代数的効果システム**: 副作用を型レベルで追跡し制御するメカニズム
   - 関数の副作用を型シグネチャに明示することで、予期しない副作用を防止します
   - 効果ハンドラにより、副作用の実装を抽象化し、テスト容易性を向上させます
   - 効果の合成により、複雑な副作用を持つプログラムを構築できます

2. **所有権モデル**: メモリ安全性を静的に保証するメカニズム
   - 各値の所有者を一意に特定し、メモリリークや二重解放を防止します
   - 借用システムにより、安全な参照を実現し、データ競合を防止します
   - リソース型により、ファイルハンドルやネットワーク接続などのリソースの安全な管理を実現します

3. **強力な型システム**: 静的型付けと型推論による安全性
   - 型エラーをコンパイル時に検出し、実行時エラーを防止します
   - 型推論により、明示的な型注釈を最小限に抑えつつ、型安全性を確保します
   - 型クラスにより、多相性と型安全なインターフェースを実現します

4. **代数的データ型**: データのモデリングのための表現力豊かな型
   - 複合データ構造を簡潔かつ型安全に表現できます
   - パターンマッチングにより、データの分解と条件分岐を統合できます
   - 網羅性チェックにより、すべてのケースが処理されていることを保証します

## 1.4 言語の進化と将来計画

Protorun言語は継続的に進化しており、以下の方向性で発展を計画しています：

1. **型システムの拡張**: 依存型や線形型などの高度な型システム機能を導入し、より精密な静的検証を実現します
2. **並行処理モデル**: アクターモデルや軽量スレッドなどの高レベルの並行処理抽象化を提供します
3. **メタプログラミング**: コンパイル時計算とコード生成のための機能を提供します
4. **開発ツール**: インクリメンタルコンパイル、言語サーバープロトコル、パッケージマネージャなどの開発ツールを整備します

# 2. 字句構造

## 2.1 字句構造の設計原則

Protorun言語の字句構造は、以下の原則に基づいて設計されています：

1. **読みやすさ**: 構文は明確で読みやすく、コードの意図を明確に伝えるべきです
2. **一貫性**: 類似の概念は類似の構文で表現し、学習と理解を容易にします
3. **簡潔さ**: 冗長性を最小限に抑え、簡潔な表現を可能にします
4. **明示性**: 重要な概念や操作は明示的に表現し、隠れた動作を避けます

## 2.2 キーワード

```
acquire   bind      effect    else      enum      export    fn
for       handle    handler   if        impl      let       match
mut       noresume  multiresume own       release   resource  resume
return    scoped    trait     type      var       with
```

Protorun言語のキーワードは、以下の原則に基づいて選択されています：

1. **最小性**: 必要最小限のキーワードを使用し、言語の学習を容易にします
2. **明確性**: 各キーワードは明確な目的を持ち、その役割が理解しやすいものを選びます
3. **一貫性**: 関連する概念には関連するキーワードを使用し、言語の一貫性を保ちます

## 2.3 演算子

```
+  -  *  /  %  =  ==  !=  <  >  <=  >=  &&  ||  !  &  |  ^  ~  <<  >>
->  =>  ::  .  ,  ;  :  ..  ...  +=  -=  *=  /=  %=  &=  |=  ^=
|>  |>* >>>  >>>*
```

Protorun言語の演算子は、以下の原則に基づいて設計されています：

1. **親しみやすさ**: 一般的なプログラミング言語で使用される演算子を採用し、学習障壁を低減します
2. **表現力**: 関数型プログラミングに適した演算子（パイプライン演算子`|>`など）を提供し、表現力を向上させます
3. **一貫性**: 演算子の優先順位と結合性は直感的で一貫したルールに従います

特に注目すべき演算子：
- `|>` (パイプライン演算子): 関数合成を左から右へと読みやすく表現します
- `|>*` (関数合成演算子): 複数の関数を合成し、新しい関数を作成します
- `>>>` (効果パイプライン演算子): 効果を持つ関数の合成を表現します
- `>>>*` (効果関数合成演算子): 効果を持つ複数の関数を合成します

## 2.4 リテラル

```
整数: 42, 0xFF, 0b1010, 1_000_000
浮動小数点: 3.14, 1e10, 1.2e-3
文字列: "hello", """複数行文字列"""
文字: 'a', '\n', '\u{1F600}'
ブール: true, false
単位: ()
```

Protorun言語のリテラルは、以下の原則に基づいて設計されています：

1. **読みやすさ**: 数値リテラルの桁区切り文字（`_`）や複数行文字列（`"""`）など、コードの読みやすさを向上させる機能を提供します
2. **表現力**: 16進数（`0xFF`）や2進数（`0b1010`）など、様々な表記法をサポートし、表現力を向上させます
3. **型安全性**: 各リテラルは明確な型を持ち、型システムと整合性があります

注意: Protorun言語では`null`リテラルは存在しません。これは、nullポインタ例外という「10億ドルの間違い」を防ぐための設計決定です。値の存在/不在はOption型で表現し、型システムによって安全に処理されます。

## 2.5 コメント

```
// 単一行コメント

/*
 * 複数行
 * コメント
 */

/// ドキュメントコメント（関数や型の直前に記述）
```

Protorun言語のコメントは、以下の原則に基づいて設計されています：

1. **親しみやすさ**: 一般的なプログラミング言語で使用されるコメント構文を採用し、学習障壁を低減します
2. **ドキュメント統合**: ドキュメントコメント（`///`）を使用することで、コードとドキュメントを密接に統合し、ドキュメントの鮮度を保ちます
3. **読みやすさ**: 複数行コメントにより、長い説明や一時的なコードの無効化を読みやすく表現できます

ドキュメントコメントは、言語のツールチェーンと統合されており、API文書の自動生成に使用されます。これにより、コードとドキュメントの一貫性が保たれ、開発者の生産性が向上します。
