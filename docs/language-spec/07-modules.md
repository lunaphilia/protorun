# 7. モジュールシステム

## 7.1 モジュールシステムの概念と目的

モジュールシステムは、コードの構造化と再利用を促進するProtorun言語の重要な機能です。この機能は以下の目的で設計されています：

1. **コードの構造化**: 関連する機能をグループ化し、コードベースを論理的に整理します。
2. **カプセル化**: 実装の詳細を隠蔽し、公開APIを明確に定義します。
3. **名前空間**: 名前の衝突を防ぎ、コードの可読性を向上させます。
4. **再利用性**: コードの再利用を促進し、ライブラリとしての配布を容易にします。
5. **依存関係管理**: モジュール間の依存関係を明示的に表現し、管理します。

モジュールシステムは、大規模なプログラムの開発において、コードの整理と保守性の向上に不可欠な役割を果たします。

## 7.2 モジュール定義

モジュールは、関連する型、関数、効果などをグループ化するための単位です。モジュールは`module`キーワードを使用して定義されます。

```
module Math {
  // 公開関数（外部からアクセス可能）
  pub fn add(a: Int, b: Int): Int = a + b
  pub fn subtract(a: Int, b: Int): Int = a - b
  
  // 非公開関数（モジュール内でのみアクセス可能）
  fn helper(): Int = 42
  
  // 公開型
  pub type Point = {
    x: Float,
    y: Float
  }
  
  // 公開定数
  pub const PI: Float = 3.14159
}
```

モジュール定義には以下の特徴があります：

1. **公開/非公開**: `pub`キーワードを使用して、モジュール外からアクセス可能な要素を指定します。
2. **スコープ**: モジュール内で定義された要素は、そのモジュールのスコープ内に存在します。
3. **ネスト**: モジュールは他のモジュール内にネストすることができます。

## 7.3 インポート

他のモジュールで定義された要素を使用するには、`import`キーワードを使用してインポートします。

```
// モジュール全体のインポート
import Math

// 特定の要素のインポート
import Math.add

// 複数の要素のインポート
import Math.{add, subtract}

// モジュールのすべての公開要素のインポート
import Math.*

// 別名を付けてインポート
import Math as M
import Math.add as addition
```

インポートには以下の特徴があります：

1. **選択的インポート**: 必要な要素のみをインポートできます。
2. **ワイルドカードインポート**: モジュールのすべての公開要素をインポートできます。
3. **別名**: インポートした要素に別名を付けることができます。
4. **可視性**: インポートした要素は、インポートしたスコープ内でのみ使用できます。

## 7.4 モジュールの階層構造

モジュールは階層構造を形成することができ、サブモジュールを定義することができます。

```
module Graphics {
  // 共通の型や関数
  pub type Color = {
    r: Int,
    g: Int,
    b: Int
  }
  
  // 2Dグラフィックスのサブモジュール
  pub module TwoD {
    pub fn drawRect(x: Int, y: Int, width: Int, height: Int, color: Color): Unit = {
      // 実装
    }
  }
  
  // 3Dグラフィックスのサブモジュール
  pub module ThreeD {
    pub fn drawCube(x: Int, y: Int, z: Int, size: Int, color: Color): Unit = {
      // 実装
    }
  }
}

// サブモジュールの使用
import Graphics.TwoD
import Graphics.ThreeD

// または
import Graphics.{TwoD, ThreeD}
```

階層構造には以下の特徴があります：

1. **名前空間の整理**: 関連する機能をさらに細かく整理できます。
2. **選択的インポート**: 必要なサブモジュールのみをインポートできます。
3. **可視性の制御**: サブモジュールの可視性も制御できます。

## 7.5 モジュールとファイルシステム

Protorun言語では、モジュール構造とファイルシステム構造を関連付けることができます。デフォルトでは、ファイルパスがモジュールパスに対応します。

```
// ファイル: graphics/two_d.pr
module Graphics.TwoD {
  // 2Dグラフィックスの実装
}

// ファイル: graphics/three_d.pr
module Graphics.ThreeD {
  // 3Dグラフィックスの実装
}

// ファイル: main.pr
import Graphics.TwoD
import Graphics.ThreeD

fn main(): Unit = {
  // グラフィックスモジュールの使用
}
```

ファイルシステムとの関連付けには以下の特徴があります：

1. **モジュールパス**: ファイルパスがモジュールパスに対応します。
2. **自動インポート**: ファイルシステム構造に基づいて、モジュールが自動的に認識されます。
3. **分割定義**: 大きなモジュールを複数のファイルに分割できます。

## 7.6 モジュールの設計上の考慮事項

モジュールを設計する際には、以下の点を考慮することが重要です：

1. **凝集度**: モジュールは関連する機能をグループ化し、高い凝集度を持つべきです。
2. **インターフェース**: モジュールは明確で一貫したインターフェースを提供すべきです。
3. **依存関係**: モジュール間の依存関係は最小限に抑え、循環依存を避けるべきです。
4. **可視性**: 必要な要素のみを公開し、実装の詳細は隠蔽すべきです。
5. **命名規則**: モジュールと要素の命名は一貫性を持ち、意図を明確に表現すべきです。

モジュールシステムは、大規模なプログラムの開発において、コードの整理と保守性の向上に不可欠な役割を果たします。適切なモジュール設計により、コードの再利用性、可読性、保守性が向上します。
